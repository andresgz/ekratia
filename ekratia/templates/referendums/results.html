{% extends "base.html" %}
{% load static bootstrap3 i18n humanize percentage %}
{% block title %}{% trans "Referendum" %}: {{ object.title }}{% endblock title %}
{% block content %}
<div class="container threads">
    <div class="referendum" ng-controller="ReferendumController">
        <span us-spinner="{radius:30, width:8, length: 16}"></span>
        <h1>{% trans "Results" %}: {{ object.title }}</h1>
        <div class="referendums-head">
            <div class="referendum-rule-title top20">{% trans "Text that this referendum will remove from our rules" %}:</div>
            <p ng-bind-html="'{{object.text_remove_rules }}' | nl2p" class="text-strike"></p>
            <div  class="referendum-rule-title top20">{% trans "Text that this referendum will add to our rules" %}:</div>
            <p ng-bind-html="'{{object.text_add_rules }}' | nl2p" class=""></p>
        </div>
    </div>

    <div class="results">
        <div class="row">
            <div class="col-md-offset-3 col-md-6 text-center">
                <h2>{% trans "Results" %}</h2>
                {% if object.is_finished %}
                {% include "referendums/_final_result.html" %}
                <br>
                {% endif %}
                {% include "referendums/_results.html" %}
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <h2 class="text-center">{% trans "Vote Details" %}</h2>
            </div>
        </div>
        {% for vote in votes %}
            <div class="row top20">
                <div class="col-md-offset-3 col-md-2 text-center">
                    <a href="/users/{{ vote.user.username }}">
                    <img ng-src="{{vote.user.get_avatar}}" alt="{{ vote.user.full_name }}" width="75" class="img-circle">
                    </a>
                </div>
                <div class="col-md-2 top20 text-center">
                    {{ vote.user.get_full_name_or_username }}
                </div>
                <div class="col-md-2 text-right top20" style="vertical-align:middle">
                    {{ vote.value|floatformat:2 }}
                </div>
            </div>
        {% endfor %}

    </div>
</div>
<h2>{% trans "Graph Representation" %}</h2>
  <div id="graph-container"></div>
  <div>Ekratia.org</div>
  <style>
    #graph-container {
        width: 100%;
        height: 500px;
    }

  </style>
{% endblock content %}
{% block extra_js %}
      <script src="{% static "lib/sigma.min.js" %}"></script>
      <script src="{% static "lib/plugins/sigma.parsers.json.min.js" %}"></script>
      <script src="{% static "lib/plugins/sigma.plugins.dragNodes.min.js" %}"></script>
<script>
sigma.utils.pkg('sigma.canvas.nodes');
sigma.canvas.nodes.image = (function() {
  var _cache = {},
      _loading = {},
      _callbacks = {};

  // Return the renderer itself:
  var renderer = function(node, context, settings) {
    var args = arguments,
        prefix = settings('prefix') || '',
        size = node[prefix + 'size'],
        color = node.color || settings('defaultNodeColor'),
        url = node.url;

    if (_cache[url]) {
      context.save();

      // Draw the clipping disc:
      context.beginPath();
      context.arc(
        node[prefix + 'x'],
        node[prefix + 'y'],
        node[prefix + 'size'],
        0,
        Math.PI * 2,
        true
      );
      context.closePath();
      context.clip();

      // Draw the image
      context.drawImage(
        _cache[url],
        node[prefix + 'x'] - size,
        node[prefix + 'y'] - size,
        2 * size,
        2 * size
      );

      // Quit the "clipping mode":
      context.restore();

      // Draw the border:
      context.beginPath();
      context.arc(
        node[prefix + 'x'],
        node[prefix + 'y'],
        node[prefix + 'size'],
        0,
        Math.PI * 2,
        true
      );
      context.lineWidth = size / 5;
      context.strokeStyle = node.color || settings('defaultNodeColor');
      context.stroke();
    } else {
      sigma.canvas.nodes.image.cache(url);
      sigma.canvas.nodes.def.apply(
        sigma.canvas.nodes,
        args
      );
    }
  };

  renderer.cache = function(url, callback) {
    if (callback)
      _callbacks[url] = callback;

    if (_loading[url])
      return;

    var img = new Image();

    img.onload = function() {
      _loading[url] = false;
      _cache[url] = img;

      if (_callbacks[url]) {
        _callbacks[url].call(this, img);
        delete _callbacks[url];
      }
    };

    _loading[url] = true;
    img.src = url;
  };

  return renderer;
})();

sigma.renderers.def = sigma.renderers.canvas;
s = new sigma({
          renderer: {
            container: document.getElementById('graph-container'),
            type: 'canvas'
          },
          settings: {
            minNodeSize: 10,
            maxNodeSize: 16,
          }
  });

sigma.parsers.json(
  "{% url 'api:graph' object.id %}",
  s,
  function() {
    s.refresh();
  }
);
</script>

{% endblock extra_js %}